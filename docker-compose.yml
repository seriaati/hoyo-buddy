services:
  # Redis (optional, for caching)
  redis:
    image: redis:8-alpine
    container_name: hb-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - hoyobuddy

  # Main bot instance (handles sharding and primary operations)
  bot-main:
    image: seriaati/hoyo-buddy:latest
    container_name: hb-main
    command: python -OO run.py --sentry --schedule --search --prometheus --novelai --deployment main
    environment:
      # Discord
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET}

      # AI image generation
      NAI_TOKEN: ${NAI_TOKEN:-}
      NAI_HOST_URL: ${NAI_HOST_URL:-}

      # API keys
      HOYO_CODES_API_KEY: ${HOYO_CODES_API_KEY:-}
      IMG_UPLOAD_API_KEY: ${IMG_UPLOAD_API_KEY:-}

      # Sentry DSNs
      BOT_SENTRY_DSN: ${BOT_SENTRY_DSN:-}
      WEB_SERVER_SENTRY_DSN: ${WEB_SERVER_SENTRY_DSN:-}
      WEB_APP_SENTRY_DSN: ${WEB_APP_SENTRY_DSN:-}
      SCHEDULER_SENTRY_DSN: ${SCHEDULER_SENTRY_DSN:-}

      # Other settings
      ENV: ${ENV:-prod}
      DB_URL: ${DB_URL}
      FERNET_KEY: ${FERNET_KEY}
      PROXY: ${PROXY:-}
      REDIS_URL: ${REDIS_URL:-}
      USER_AGENT: ${USER_AGENT:-}

      # Heartbeat
      MAIN_HEARTBEAT_URL: ${MAIN_HEARTBEAT_URL:-}
      SCHEDULER_HEARTBEAT_URL: ${SCHEDULER_HEARTBEAT_URL:-}

      # Ports
      WEB_SERVER_PORT: ${WEB_SERVER_PORT:-}
      WEB_APP_PORT: ${WEB_APP_PORT:-}
      PROMETHEUS_PORT: ${PROMETHEUS_PORT:-}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8081/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - 1panel-network
      - hoyobuddy
    volumes:
      - ./logs:/app/logs
      - ./.cache:/app/.cache

  # Web app (Flet authentication interface)
  web-app:
    image: seriaati/hoyo-buddy:latest
    container_name: hb-app
    command: python -OO run_web_app.py --sentry
    environment:
      # Discord
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET}

      # AI image generation
      NAI_TOKEN: ${NAI_TOKEN:-}
      NAI_HOST_URL: ${NAI_HOST_URL:-}

      # API keys
      HOYO_CODES_API_KEY: ${HOYO_CODES_API_KEY:-}
      IMG_UPLOAD_API_KEY: ${IMG_UPLOAD_API_KEY:-}

      # Sentry DSNs
      BOT_SENTRY_DSN: ${BOT_SENTRY_DSN:-}
      WEB_SERVER_SENTRY_DSN: ${WEB_SERVER_SENTRY_DSN:-}
      WEB_APP_SENTRY_DSN: ${WEB_APP_SENTRY_DSN:-}
      SCHEDULER_SENTRY_DSN: ${SCHEDULER_SENTRY_DSN:-}

      # Other settings
      ENV: ${ENV:-prod}
      DB_URL: ${DB_URL}
      FERNET_KEY: ${FERNET_KEY}
      PROXY: ${PROXY:-}
      REDIS_URL: ${REDIS_URL:-}
      USER_AGENT: ${USER_AGENT:-}

      # Heartbeat
      MAIN_HEARTBEAT_URL: ${MAIN_HEARTBEAT_URL:-}
      SCHEDULER_HEARTBEAT_URL: ${SCHEDULER_HEARTBEAT_URL:-}

      # Ports
      WEB_SERVER_PORT: ${WEB_SERVER_PORT:-}
      WEB_APP_PORT: ${WEB_APP_PORT:-}
      PROMETHEUS_PORT: ${PROMETHEUS_PORT:-}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:${WEB_APP_PORT:-8645} || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    ports:
      - "${WEB_APP_PORT:-8645}:${WEB_APP_PORT:-8645}"
    restart: unless-stopped
    networks:
      - 1panel-network
      - hoyobuddy
    volumes:
      - ./logs:/app/logs

  # Scheduler (handles automated tasks: check-ins, redeems, notifications)
  scheduler:
    image: seriaati/hoyo-buddy:latest
    container_name: hb-scheduler
    command: python -OO run_scheduler.py --sentry
    environment:
      # Discord
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET}

      # AI image generation
      NAI_TOKEN: ${NAI_TOKEN:-}
      NAI_HOST_URL: ${NAI_HOST_URL:-}

      # API keys
      HOYO_CODES_API_KEY: ${HOYO_CODES_API_KEY:-}
      IMG_UPLOAD_API_KEY: ${IMG_UPLOAD_API_KEY:-}

      # Sentry DSNs
      BOT_SENTRY_DSN: ${BOT_SENTRY_DSN:-}
      WEB_SERVER_SENTRY_DSN: ${WEB_SERVER_SENTRY_DSN:-}
      WEB_APP_SENTRY_DSN: ${WEB_APP_SENTRY_DSN:-}
      SCHEDULER_SENTRY_DSN: ${SCHEDULER_SENTRY_DSN:-}

      # Other settings
      ENV: ${ENV:-prod}
      DB_URL: ${DB_URL}
      FERNET_KEY: ${FERNET_KEY}
      PROXY: ${PROXY:-}
      REDIS_URL: ${REDIS_URL:-}
      USER_AGENT: ${USER_AGENT:-}

      # Heartbeat
      MAIN_HEARTBEAT_URL: ${MAIN_HEARTBEAT_URL:-}
      SCHEDULER_HEARTBEAT_URL: ${SCHEDULER_HEARTBEAT_URL:-}

      # Ports
      WEB_SERVER_PORT: ${WEB_SERVER_PORT:-}
      WEB_APP_PORT: ${WEB_APP_PORT:-}
      PROMETHEUS_PORT: ${PROMETHEUS_PORT:-}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8082/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - 1panel-network
      - hoyobuddy
    volumes:
      - ./logs:/app/logs

  # Web server (Geetest verification)
  web-server:
    image: seriaati/hoyo-buddy:latest
    container_name: hb-web-server
    command: python -OO run_web_server.py --sentry
    environment:
      # Discord
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET}

      # AI image generation
      NAI_TOKEN: ${NAI_TOKEN:-}
      NAI_HOST_URL: ${NAI_HOST_URL:-}

      # API keys
      HOYO_CODES_API_KEY: ${HOYO_CODES_API_KEY:-}
      IMG_UPLOAD_API_KEY: ${IMG_UPLOAD_API_KEY:-}

      # Sentry DSNs
      BOT_SENTRY_DSN: ${BOT_SENTRY_DSN:-}
      WEB_SERVER_SENTRY_DSN: ${WEB_SERVER_SENTRY_DSN:-}
      WEB_APP_SENTRY_DSN: ${WEB_APP_SENTRY_DSN:-}
      SCHEDULER_SENTRY_DSN: ${SCHEDULER_SENTRY_DSN:-}

      # Other settings
      ENV: ${ENV:-prod}
      DB_URL: ${DB_URL}
      FERNET_KEY: ${FERNET_KEY}
      PROXY: ${PROXY:-}
      REDIS_URL: ${REDIS_URL:-}
      USER_AGENT: ${USER_AGENT:-}

      # Heartbeat
      MAIN_HEARTBEAT_URL: ${MAIN_HEARTBEAT_URL:-}
      SCHEDULER_HEARTBEAT_URL: ${SCHEDULER_HEARTBEAT_URL:-}

      # Ports
      WEB_SERVER_PORT: ${WEB_SERVER_PORT:-}
      WEB_APP_PORT: ${WEB_APP_PORT:-}
      PROMETHEUS_PORT: ${PROMETHEUS_PORT:-}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:${WEB_SERVER_PORT:-5000}/health || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    ports:
      - "${WEB_SERVER_PORT:-5000}:${WEB_SERVER_PORT:-5000}"
    restart: unless-stopped
    networks:
      - 1panel-network
      - hoyobuddy
    volumes:
      - ./logs:/app/logs

volumes:
  redis_data:
    driver: local

networks:
  hoyobuddy:
    driver: bridge
  1panel-network:
    external: true
    name: 1panel-network
